#!/bin/bash

# Ragpicker + Viper Autoinstall Script v0.1
# by Chris Campbell
#
# Twitter: @t0x0_nz
# GitHub: t0x0-nz
# Blog: bytefog.blogspot.com

echo "Ensuring the box is up to date..."
apt-get update -y
apt-get upgrade -y

echo "Fetching required packages. Some may require user input..."
apt-get -f install autoconf build-essential clamav clamav-freshclam exiftool flex gcc git libffi-dev libfuzzy-dev libimage-exiftool-perl libjansson-dev libmagic-dev libssl-dev libtool mongodb pff-tools python-beautifulsoup python-bitstring python-bottle python-cffi python-cryptography python-dateutil python-dev python-django python-dnspython python-enum34 python-hachoir-core python-hachoir-metadata python-hachoir-parser python-hachoir-regex python-hachoir-subfile python-hachoir-urwid python-hachoir-wx python-httplib2 python-idna python-ipaddress python-jinja2 python-jsonpickle python-levenshtein python-m2crypto python-magic python-pbkdf2 python-pefile python-pip python-prettytable python-pyasn1 python-pycparser python-pyelftools python-requests python-requests-cache python-simplejson python-six python-socks python-sqlalchemy python-yapsy swig unrar-free wine winetricks -y
pip install pydeep olefile oletools pycrypto pylzma pymisp pymongo==2.9 pypdns pype32 pypssl r2pipe scandir terminaltables virustotal-api

echo "Fixing up Wine..."
winetricks nocrashdialog

mkdir ~/src_tmp
cd ~/src_tmp

echo "Installing YARA..."
git clone https://github.com/plusvic/yara.git
cd yara
./bootstrap.sh
./configure --with-crypto --enable-cuckoo --enable-magic
make
make install
apt-get -f install python-yara -y
cd ..

echo "Installing ssdeep..."
wget http://heanet.dl.sourceforge.net/project/ssdeep/ssdeep-2.13/ssdeep-2.13.tar.gz
tar -xzvf ssdeep-2.13.tar.gz
cd ssdeep-2.13
./configure && make
sudo make install
cd ..

echo "Installing pyexiftool..."
git clone https://github.com/smarnach/pyexiftool
cd pyexiftool
python setup.py install 
cd ~

rm -rf ~/src_tmp

echo "Making user..."
mkdir /home/hunter
useradd -d /home/hunter -r -s /bin/false hunter
chown hunter:hunter /home/hunter

echo "Installing Viper..."
cd /opt
git clone https://github.com/viper-framework/viper.git
chown -R hunter:hunter /opt/viper
cd viper
sudo make install

echo "Installing BitDefender scanner..."
add-apt-repository 'deb http://download.bitdefender.com/repos/deb/ bitdefender non-free'
wget -q http://download.bitdefender.com/repos/deb/bd.key.asc -O- |  apt-key add -
apt-get update -y
# TODO: Address key issue.
apt-get install bitdefender-scanner -y --allow-unauthenticated

echo "Please manually run 'bdscan' after the script completes and accept the license."

echo "Fetching Ragpicker..."
cd /opt
git clone https://github.com/t0x0-nz/ragpicker
chown -R hunter:hunter /opt/ragpicker

# TODO: Ragpicker and Viper init.d and housekeeping scripts.

echo "Done!"

echo "Ragpicker can be started using 'cd /opt/ragpicker && sudo -H -u hunter python ./ragpicker.py'"
echo "Viper API can be started using 'cd /opt/viper && sudo -H -u hunter ./viper-api'"
echo "Viper Web Interface can be started using 'cd /opt/viper && sudo -H -u hunter ./viper-web'"
