Dionaea Install Notes
"""""""""""""""""""""

- Spin up t2.micro Ubuntu 14.04 EC2 instance. Create and apply security group with the following ports:
ftp (21/tcp) 
http/https (80/tcp and 443/tcp) 
nameserver (42/tcp) 
msrpc (135/tcp ) 
smb (445/tcp) 
tftp (69/udp) 
ms-sql (1433/tcp)
pptp (1723/tcp)
scada (1883/tcp)
upnp (1900/udp)
mysql (port 3306/tcp) 
sip/sip-tls (5060/tcp+udp and 5061/tcp)
memcache (11211/tcp)

- Relocate the private key:
mv PrivateKey.pem ~/.ssh
chmod 400 ~/.ssh/PrivateKey.pem

- Connect to the instance:
ssh -i ~/.ssh/PrivateKey.pem ubuntu@ec2-xx-xxx-xxx-xx.us-west-2.compute.amazonaws.com

- Install Dionaea and p0f via apt:
sudo add-apt-repository ppa:honeynet/nightly -y
sudo apt-get update
apt-get install software-properties-common python-software-properties -y
sudo apt-get upgrade -y
(reboot if required for kernel updates)
sudo apt-get -f install p0f dionaea -y

- Edit the main config:
nano /opt/dionaea/etc/dionaea/dionaea.cfg
-- Edit as follows (SSL details as example):
TO> default.levels=info
TO> error.levels=warning,error
TO> ssl.default.c=XX
TO> ssl.default.cn=XXXX.domain.com
TO> ssl.default.o=XXXX Inc
TO> ssl.default.ou=XX

- Create the MySQL target database:
-- Copy out wordlist.txt and generate_user_db.py to your home folder.
chmod +x generate_user_db.py
sudo -u dionaea touch /opt/dionaea/var/dionaea/target_db.sqlite
sudo -u dionaea ./generate_user_db.py

- Edit the MySQL config:
nano /opt/dionaea/etc/dionaea/services-available/mysql.yaml
-- Uncomment the following two lines and correct the path of the user database:
psn:
  path: "/opt/dionaea/var/dionaea/target_db.sqlite"

- Edit the PPTP config:
nano /opt/dionaea/etc/dionaea/services-available/pptp.yaml
-- Uncomment three lines under the device you wish to emulate, e.g.
firmware_revision: 4608
hostname: PIX
vendor_name: Cisco Systems

- Edit the SIP script:
nano /opt/dionaea/lib/dionaea/python/dionaea/sip/extras.py
-- Comment out:
#self.root_path = os.getcwd()
#self.users = os.path.join(self.root_path, config.get("users", "var/dionaea/sipaccounts.sqlite"))
-- Edit both occurences of:
FROM> sqlite3.connect(self.users)
TO> sqlite3.connect("/opt/dionaea/var/dionaea/sipaccounts.sqlite")

- Edit the SMB script:
nano /opt/dionaea/lib/dionaea/python/dionaea/smb/include/smbfields.py
-- Edit as follows (where X is specified, define your own entry):
FROM>        ConditionalField(UnicodeNullField(
FROM>            "OemDomainName", "WORKGROUP"), lambda x: not x.Capabilities & CAP_EXTENDED_SECURITY),

TO>        ConditionalField(UnicodeNullField(
TO>            "OemDomainName", "XXXX"), lambda x: not x.Capabilities & CAP_EXTENDED_SECURITY),

FROM>        ConditionalField(UnicodeNullField(
FROM>            "ServerName", "HOMEUSER-XXXX"), lambda x: not x.Capabilities & CAP_EXTENDED_SECURITY),

TO>        ConditionalField(UnicodeNullField(
TO>            "ServerName", "XXXX"), lambda x: not x.Capabilities & CAP_EXTENDED_SECURITY),


- It's not necessary to edit the FTP script in later releases. You can edit the welcome banner in /opt/dionaea/etc/dionaea/services-available/ftp.yaml

- Edit the MSSQL script:
nano /opt/dionaea/lib/dionaea/python/dionaea/mssql/mssql.py
-- Edit as follows:
FROM> r.VersionToken.TokenType = 0x00
TO> r.VersionToken.TokenType = 0xAA

?> Refer to http://www.freetds.org/tds.html#responses for options.

- Create a logrotate script to rotate the logs on a daily basis using dionaea.logrotate (copy to /etc/logrotate.d/dionaea)

- Enable Dionaea p0f handler:
ln -s /opt/dionaea/etc/dionaea/ihandlers-available/p0f.yaml /opt/dionaea/etc/dionaea/ihandlers-enabled

- Make p0f init script using p0f.init (copy to /etc/init.d/p0f) then:
chmod +x /etc/init.d/p0f

- Set all to autostart:
update-rc.d dionaea defaults
update-rc.d p0f defaults

- Start the honeypot:
/etc/init.d/p0f start
/etc/init.d/dionaea start

- Make sure that Dionaea is listening on all expected ports:
netstat -putan|grep dionaea

- Check the error log in /opt/dionaea/var/dionaea/dionaea-errors.log